on:
  workflow_dispatch:
  push:
    branches:
      - main
      - quarto

env:
  QUARTO_PROFILE: ci
  IMAGE_NAME: lnnrtwttkhn/rdm-datalad

name: Quarto Publish

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull Docker image
        run: |
          # Try to pull branch-specific image first, fallback to latest
          if ! docker pull ${{ env.IMAGE_NAME }}:${{ github.ref_name }}; then
            echo "Branch-specific image not found, using latest"
            docker pull ${{ env.IMAGE_NAME }}:latest
            docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          fi

      - name: Render Quarto website in Docker
        run: |
          docker run --rm -v ${{ github.workspace }}:/app ${{ env.IMAGE_NAME }}:${{ github.ref_name }} \
            sh -c "uv run make generate-install && uv run quarto add --no-prompt mcanouil/quarto-collapse-output && uv run quarto render /app --profile ci"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site